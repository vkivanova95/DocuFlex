{% extends 'base.html' %}

{% block content %}
<div class="container">
  <div class="card shadow-sm p-4">
    <h4 class="custom-header">–î–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –∞–Ω–µ–∫—Å</h4>

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="annex_type" value="{{ annex_type }}">
      <input type="hidden" name="step" value="complete">

        <!-- –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏ -->
        <h5 class="mt-4">üìÑ –î–∞–Ω–Ω–∏ –æ—Ç –∑–∞—è–≤–∫–∞</h5>
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Request number:</label>
            <input type="text" class="form-control" value="{{ form.request_number.value }}" disabled>
            {{ form.request_number.as_hidden }}
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Annex number:</label>
            <input type="text" class="form-control" value="{{ form.annex_number.value }}" disabled>
            {{ form.annex_number.as_hidden }}
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">–ê–Ω–µ–∫—Å –¥–∞—Ç–∞:</label>
            <input type="text" class="form-control" value="{{ form.annex_date.value }}" disabled>
            {{ form.annex_date.as_hidden }}
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">–ì—Ä–∞–¥:</label>
            <input type="text" class="form-control" value="{{ form.city.value }}" disabled>
            {{ form.city.as_hidden }}
          </div>
        </div>

      <!-- –ü–æ–ª–µ—Ç–∞ –∑–∞ –¥–æ–ø—ä–ª–≤–∞–Ω–µ -->
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

        {% if annex_type == 'standard' %}
            <!-- –ü–æ–ª–µ—Ç–∞—Ç–∞ –æ—Ç AnnexStandardForm -->
          <div class="row">
          <h5 class="mt-4">I. –ü—Ä–æ–º–µ–Ω–∏ –≤ —Ä–∞–∑–º–µ—Ä–∞ –∏ –≤–∞–ª—É—Ç–∞—Ç–∞ –Ω–∞ –∫—Ä–µ–¥–∏—Ç–∞:</h5>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_amount_reduction.id_for_label }}">–°—É–º–∞ –Ω–∞ –Ω–∞–º–∞–ª–µ–Ω–∏–µ</label>
              {{ form.new_amount_reduction }}
              {{ form.new_amount_reduction.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.amount_increase.id_for_label }}">–°—É–º–∞ –Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ</label>
              {{ form.amount_increase }}
              {{ form.amount_increase.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_amount_increase.id_for_label }}">–ù–æ–≤ —Ä–∞–∑–º–µ—Ä —Å–ª–µ–¥ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ</label>
              {{ form.new_amount_increase }}
              {{ form.new_amount_increase.errors }}
            </div>
          </div>

        <div class="row">
            <h5 class="mt-4">II. –ü—Ä–æ–º–µ–Ω–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ç–∞ –∑–∞ —É—Å–≤–æ—è–≤–∞–Ω–µ/ –ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Ç –∫—Ä–µ–¥–∏—Ç–∞:</h5>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.stop_disbursement.id_for_label }}">–ü—Ä–µ–∫—Ä–∞—Ç—è–≤–∞–Ω–µ –Ω–∞ —É—Å–≤–æ—è–≤–∞–Ω–µ—Ç–æ</label>
              {{ form.stop_disbursement }}
              {{ form.stop_disbursement.errors }}
            </div>
        </div>

        <div class="row">
          <h5 class="mt-4">III. –ü—Ä–æ–º–µ–Ω–∏ –≤ —Å—Ä–æ–∫–æ–≤–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –ø–æ–ª–∑–≤–∞–Ω–µ—Ç–æ –∏ –Ω–∞—á–∏–Ω –Ω–∞ –ø–æ–≥–∞—Å—è–≤–∞–Ω–µ –Ω–∞ –∫—Ä–µ–¥–∏—Ç–∞:</h5>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_disbursement_date.id_for_label }}">–ù–æ–≤–∞ –¥–∞—Ç–∞ –Ω–∞ —É—Å–≤–æ—è–≤–∞–Ω–µ</label>
              {{ form.new_disbursement_date }}
              {{ form.new_disbursement_date.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_repayment_date.id_for_label }}">–ù–æ–≤–∞ –¥–∞—Ç–∞ –Ω–∞ –ø–æ–≥–∞—Å—è–≤–∞–Ω–µ</label>
              {{ form.new_repayment_date }}
              {{ form.new_repayment_date.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.effective_from.id_for_label }}">–°—á–∏—Ç–∞–Ω–æ –æ—Ç </label>
              {{ form.effective_from }}
              {{ form.effective_from.errors }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.repayment_plan.id_for_label }}">–ù–æ–≤ –ø–æ–≥–∞—Å–∏—Ç–µ–ª–µ–Ω –ø–ª–∞–Ω</label>
              {{ form.repayment_plan }}
              {{ form.repayment_plan.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_ceiling.id_for_label }}">–ù–æ–≤ –ø–ª–∞—Ñ–æ–Ω</label>
              {{ form.new_ceiling }}
              {{ form.new_ceiling.errors }}
            </div>
          </div>

        <div class="row">
          <h5 class="mt-4">IV. –ü—Ä–æ–º–µ–Ω–∏ –≤ –ª–∏—Ö–≤–∏, —Ç–∞–∫—Å–∏ –∏ –∫–æ–º–∏—Å–∏–æ–Ω–Ω–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞:</h5>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.new_interest.id_for_label }}">–ù–æ–≤–∞ –ª–∏—Ö–≤–∞</label>
              {{ form.new_interest }}
              {{ form.new_interest.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.no_fees.id_for_label }}">–ë–µ–∑ —Ç–∞–∫—Å–∏</label>
              {{ form.no_fees }}
              {{ form.no_fees.errors }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.fee_review.id_for_label }}">–¢–∞–∫—Å–∞ —Ä–∞–∑–≥–ª–µ–∂–¥–∞–Ω–µ </label>
              {{ form.fee_review }}
              {{ form.fee_review.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.fee_management.id_for_label }}">–¢–∞–∫—Å–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
              {{ form.fee_management }}
              {{ form.fee_management.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.fee_commitment.id_for_label }}">–¢–∞–∫—Å–∞ –∞–Ω–≥–∞–∂–∏–º–µ–Ω—Ç</label>
              {{ form.fee_commitment }}
              {{ form.fee_commitment.errors }}
            </div>
          </div>

        {% elif annex_type == 'deletion' %}
          <h5 class="mt-4">üìÑ –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.repaid_amount.id_for_label }}">–ü–æ–≥–∞—Å–µ–Ω–∞ —Å—É–º–∞</label>
              {{ form.repaid_amount }}
              {{ form.repaid_amount.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.deed_number.id_for_label }}">–ù–æ—Ç–∞—Ä–∏–∞–ª–µ–Ω –∞–∫—Ç ‚Ññ</label>
              {{ form.deed_number }}
              {{ form.deed_number.errors }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label" for="{{ form.collateral_description.id_for_label }}">–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–µ–∑–ø–µ—á–µ–Ω–∏–µ</label>
               {{ form.collateral_description }}
               {{ form.collateral_description.errors }}
            </div>
          </div>
        {% endif %}


        {% if annex_type == 'standard' %}
          <h5 class="mt-4">V. –î—Ä—É–≥–∏ —É—Å–ª–æ–≤–∏—è:</h5>
          <div id="formset-area">
            {{ formset.management_form }}
            {% for fs_form in formset %}
              <div class="form-group mb-2">
                {{ fs_form.text }}
                {{ fs_form.text.errors }}
              </div>
            {% endfor %}
          </div>
          <button type="button" id="add-form" class="btn btn-secondary mt-2">+ –î–æ–±–∞–≤–∏ —Ä–µ–¥</button>
        {% endif %}

    <!-- –°–∫—Ä–∏—Ç–æ –ø–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –æ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç–∞ —Ñ–æ—Ä–º–∞ -->
    <input type="hidden" name="request_number" value="{{ form.request_number.value }}">
    <input type="hidden" name="annex_number" value="{{ form.annex_number.value }}">
    <input type="hidden" name="annex_date" value="{{ form.annex_date.value|date:'d-m-Y' }}">
    <input type="hidden" name="city" value="{{ form.city.value }}">

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∞–Ω–µ–∫—Å</button>
      </div>
    </form>
  </div>
</div>


<script>
  const formsetArea = document.getElementById('formset-area');
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  const addFormBtn = document.getElementById('add-form');

  if (addFormBtn) {
    addFormBtn.addEventListener('click', function () {
      const currentFormCount = parseInt(totalForms.value);
      const lastForm = formsetArea.querySelector('.form-group');  // üëà —Ç–æ—á–Ω–æ —Ç–æ–≤–∞ —Ç—ä—Ä—Å–∏
      const newForm = lastForm.cloneNode(true);

      // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞
      const input = newForm.querySelector('input');
      if (input) {
        input.value = '';
      }

      // –°–º—è–Ω–∞ –Ω–∞ –∏–Ω–¥–µ–∫—Å–∞ (form-0, form-1 –∏ —Ç.–Ω.)
      const regex = new RegExp(`form-(\\d+)-`, 'g');
      newForm.innerHTML = newForm.innerHTML.replace(regex, `form-${currentFormCount}-`);

      formsetArea.appendChild(newForm);
      totalForms.value = currentFormCount + 1;
    });
  }
</script>

{% endblock %}
